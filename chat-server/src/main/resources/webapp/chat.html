<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <script src="js/jquery-3.4.1.min.js"></script>
    <!-- <script src="js/fabric-3.2.0.min.js"></script> -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <textarea rows="10" cols="50" id="chatHistoryText">
        chat room
                </textarea>
    <p></p>
    <input type="text" id="inputText" value="hello">

    <button onclick="sendMsg()">send</button>

    <script>
        // layout settings
        // websocket client
        var ws;
        var pageURL = $(location).attr("href");

        $(document).ready(function() {
            console.log("page url: ", pageURL);
            var location = getLocation(pageURL);
            var query = getJsonFromUrl(location.search);
            var token = query["token"]
            console.log("token: ", token);
            if (token !== undefined && token !== "") {
                console.warn("no token is setting");
            }
            var wsUri = getWsUri(location);
            console.log("ws uri: ", wsUri);
            ws = connectToWS(wsUri, onMsgCallback = msgListen);
        });

        function connectToWS(endpoint, onMsgCallback) {
            var ws = new WebSocket(endpoint);

            ws.onmessage = onMsgCallback;
            ws.onopen = function(evt) {
                console.log("onopen.");
            };
            ws.onclose = function(evt) {
                console.log("onclose.");
            };
            ws.onerror = function(evt) {
                console.log("Error!");
            };
            return ws;
        }

        function sendMsg() {
            $("#inputText").val("Hello World");
        }

        function send(ws, msg) {
            console.log("send msg: ", msg);
            ws.send(msg);
        }

        function msgListen(event) {
            var leng;
            if (event.data.size === undefined) {
                leng = event.data.length
            } else {
                leng = event.data.size
            }
            console.log("onmessage. size: " + leng + ", content: " + event.data);
        }

        function getLocation(href) {
            var l = document.createElement("a");
            l.href = href;
            return l;
        }

        function getWsUri(location) {
            var wsUri = "ws://" + location.hostname + ":" + location.port + "/ws";
            return wsUri;
        }

        function getJsonFromUrl(url) {
            var query = url.substr(1);
            var result = {};
            query.split("&").forEach(function(part) {
                var item = part.split("=");
                result[item[0]] = decodeURIComponent(item[1]);
            });
            return result;
        }
    </script>
</body>

</html>